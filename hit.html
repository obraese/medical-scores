<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HIT-Diagnostik Tool (4T-Score + Laboralgorithmus)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; line-height: 1.35; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    h2 { font-size: 18px; margin: 22px 0 10px; }
    .muted { color: #666; font-size: 13px; margin-bottom: 14px; }
    .box { border: 1px solid #ccc; padding: 16px; max-width: 980px; border-radius: 10px; }

    .switch {
      display: flex; gap: 10px; flex-wrap: wrap;
      padding: 10px 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 14px;
      align-items: center;
      background: #fcfcfc;
    }
    .switch label { cursor: pointer; margin-right: 10px; }

    .item {
      border: 1px solid #eee;
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      background: #fff;
    }

    .item label {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      cursor: pointer;
      width: 100%;
    }

    .content { flex: 1; }
    .title { font-weight: bold; margin-bottom: 4px; }
    .explain { font-size: 13px; color: #444; margin-left: 22px; }

    .pts {
      color: #444;
      font-size: 13px;
      white-space: nowrap;
      margin-left: 10px;
    }

    .scoreline {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .score { font-size: 30px; font-weight: bold; }

    button {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
    }
    button:hover { background: #f2f2f2; }

    .copied { font-size: 13px; color: green; }

    .interpret {
      margin-top: 8px;
      font-size: 13px;
      color: #333;
      padding: 10px 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fcfcfc;
    }
    .interpret strong { margin-right: 6px; }

    .divider { height: 1px; background: #eee; margin: 18px 0; }

    /* ===== Kategorieband ===== */
    .band {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }
    .band-3 { grid-template-columns: repeat(3, 1fr); }
    .band-4 { grid-template-columns: repeat(4, 1fr); }
    @media (max-width: 780px) {
      .band-4 { grid-template-columns: repeat(2, 1fr); }
    }

    .bandbox {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fafafa;
      font-size: 13px;
      text-align: center;
    }
    .bandbox strong { display:block; margin-bottom: 4px; }

    .band-active {
      background: #eef6ff;
      border: 2px solid #7aa7e6;
      font-size: 15px;
      font-weight: bold;
    }

    .hidden { display: none; }

    /* ===== Inputs ===== */
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px;
    }
    select, input[type="number"] {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 14px;
    }
    .pill {
      display: inline-block;
      padding: 3px 8px;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      font-size: 12px;
      color: #444;
      background: #fafafa;
      margin-left: 8px;
    }

    .warn {
      border: 1px solid #ffe0b3;
      background: #fff7e8;
    }
    .ok {
      border: 1px solid #dbead5;
      background: #f5fbf2;
    }
    .danger {
      border: 1px solid #ffd0d0;
      background: #fff2f2;
    }

    .smallnote { font-size: 12px; color: #555; margin-top: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>

<h1>HIT-Diagnostik Tool (4T-Score + Laboralgorithmus)</h1>
<div class="muted">
  Arbeits-/Lernhilfe. Keine Patientendaten speichern. Klinische Entscheidung immer im Kontext (Thromboserisiko/Blutungsrisiko/OP-Setting/Intensivmedizin).
</div>

<div class="box">

  <!-- ===== View Switch ===== -->
  <div class="switch">
    <strong>Ansicht:</strong>
    <label><input type="radio" name="view" id="view_algo" checked> Algorithmus</label>
    <label><input type="radio" name="view" id="view_4t"> 4T-Score</label>
    <label><input type="radio" name="view" id="view_lab"> Labor</label>
    <span style="flex:1;"></span>
    <button id="reset">Alles zurücksetzen</button>
  </div>

  <!-- ===================== ALGORITHMUS ===================== -->
  <div id="section_algo">
    <h2>Algorithmus (kompletter Ablauf)</h2>

    <div class="interpret" id="algo_summary">
      <strong>Status:</strong> —
    </div>

    <div class="band band-3" id="band_4t_algo">
      <div id="band_low_algo" class="bandbox">
        <strong>4T 0–3</strong>
        niedrige Vortest-Wahrscheinlichkeit
      </div>
      <div id="band_int_algo" class="bandbox">
        <strong>4T 4–5</strong>
        intermediär
      </div>
      <div id="band_high_algo" class="bandbox">
        <strong>4T 6–8</strong>
        hoch
      </div>
    </div>

    <div class="divider"></div>

    <div class="item">
      <div class="title">1) 4T-Score erheben</div>
      <div class="explain">
        Der 4T-Score steuert den kompletten diagnostischen Workflow: bei 0–3 ist HIT II sehr unwahrscheinlich; ab ≥4 wird labordiagnostisch abgeklärt und Heparin i.d.R. gestoppt.
      </div>
      <div class="row">
        <button id="jump_4t">Zum 4T-Score</button>
        <span class="pill">aktueller 4T: <span class="mono" id="algo_4t_val">0</span></span>
      </div>
    </div>

    <div class="item">
      <div class="title">2) Sofortmaßnahmen (abhängig vom 4T-Score)</div>
      <div class="explain" id="algo_immediate">
        —
      </div>
    </div>

    <div class="item">
      <div class="title">3) Labordiagnostik (Stufe 1: Immunoassay)</div>
      <div class="explain">
        PF4/Heparin-Antikörpertest (z. B. ELISA/CLIA/EIA) ist hochsensitiv. Ein negatives Ergebnis macht HIT II sehr unwahrscheinlich. Ein positives Ergebnis erfordert Einordnung im Kontext (Vortestwahrscheinlichkeit, Signalstärke) und i. d. R. Bestätigung per funktionellem Test.
      </div>
      <div class="row">
        <button id="jump_lab">Zum Labor</button>
        <span class="pill">PF4-Status: <span class="mono" id="algo_pf4_val">nicht gesetzt</span></span>
      </div>
      <div class="smallnote">
        Hinweis: Viele Labore berichten zusätzlich eine <span class="mono">OD</span> bzw. Signalstärke. Hohe Signale korrelieren stärker mit plättchenaktivierenden Antikörpern, ersetzen aber keinen funktionellen Test.
      </div>
    </div>

    <div class="item">
      <div class="title">4) Labordiagnostik (Stufe 2: Funktioneller Test)</div>
      <div class="explain">
        Funktionelle Tests (z. B. SRA, HIPA) zeigen plättchenaktivierende Antikörper und bestätigen HIT II bei passender Klinik.
      </div>
      <div class="row">
        <span class="pill">Funktionell: <span class="mono" id="algo_func_val">nicht gesetzt</span></span>
      </div>
    </div>

    <div class="item">
      <div class="title">5) Gesamteinordnung & nächster Schritt</div>
      <div class="explain" id="algo_conclusion">
        —
      </div>

      <div class="scoreline">
        <button id="copy_summary">Zusammenfassung kopieren</button>
        <span class="copied" id="copied" style="display:none;">✓ kopiert</span>
      </div>
    </div>
  </div>

  <!-- ===================== 4T SCORE ===================== -->
  <div id="section_4t" class="hidden">
    <h2>4T-Score (Vortest-Wahrscheinlichkeit)</h2>

    <!-- Thrombocytopenia -->
    <div class="item">
      <div class="title">T1 – Thrombozytenabfall</div>
      <div class="explain">Wähle genau eine Option.</div>
      <div class="row">
        <select id="t_platelets">
          <option value="0">Bitte auswählen…</option>
          <option value="2">>50% Abfall UND Nadir ≥20 G/l (2 Punkte)</option>
          <option value="1">30–50% Abfall ODER Nadir 10–19 G/l (1 Punkt)</option>
          <option value="0x"><30% Abfall ODER Nadir &lt;10 G/l (0 Punkte)</option>
        </select>
      </div>
      <div class="smallnote">
        Praxis: HIT II zeigt häufig einen Abfall um >50% mit Nadir typischerweise >20 G/l (sehr niedrige Nadirs sprechen eher für andere Ursachen, z. B. Sepsis/DIC, Medikamente).
      </div>
    </div>

    <!-- Timing -->
    <div class="item">
      <div class="title">T2 – Timing in Relation zur Heparingabe</div>
      <div class="explain">Wähle genau eine Option.</div>
      <div class="row">
        <select id="t_timing">
          <option value="0">Bitte auswählen…</option>
          <option value="2">Beginn Tag 5–10 nach Start ODER ≤1 Tag bei Heparinexposition &lt;30 Tage (2 Punkte)</option>
          <option value="1">Konsistent, aber nicht klar (z. B. Tag 5–10 unklar, oder Exposition 30–100 Tage) (1 Punkt)</option>
          <option value="0x">Beginn &lt;4 Tage ohne Vorheparinisierung (0 Punkte)</option>
        </select>
      </div>
      <div class="smallnote">
        “Rapid-onset” ist typisch bei kürzlicher Heparinexposition. Ein sehr früher Abfall ohne Vorheparin spricht gegen HIT II.
      </div>
    </div>

    <!-- Thrombosis -->
    <div class="item">
      <div class="title">T3 – Thrombose / andere klinische Ereignisse</div>
      <div class="explain">Wähle genau eine Option.</div>
      <div class="row">
        <select id="t_thrombosis">
          <option value="0">Bitte auswählen…</option>
          <option value="2">Neue Thrombose/Embolie, Hautnekrose, akute systemische Reaktion nach Heparinbolus (2 Punkte)</option>
          <option value="1">Progressive/rezidivierende Thrombose, “suspected” Thrombose (noch nicht bestätigt) (1 Punkt)</option>
          <option value="0x">Keine (0 Punkte)</option>
        </select>
      </div>
    </div>

    <!-- Other causes -->
    <div class="item">
      <div class="title">T4 – Andere Ursachen für Thrombozytopenie</div>
      <div class="explain">Wähle genau eine Option.</div>
      <div class="row">
        <select id="t_other">
          <option value="0">Bitte auswählen…</option>
          <option value="2">Keine plausible andere Ursache (2 Punkte)</option>
          <option value="1">Mögliche andere Ursache (1 Punkt)</option>
          <option value="0x">Sichere andere Ursache (0 Punkte)</option>
        </select>
      </div>
      <div class="smallnote">
        Typische Alternativen: Sepsis, DIC, massive Transfusion/Verdünnung, post-OP, ECMO/CRRT, Medikamente (z. B. Linezolid), TMA, ITP.
      </div>
    </div>

    <div class="scoreline">
      <div>4T-Score:</div>
      <div class="score" id="t_result">0</div>
      <button id="t_copy">4T-Score kopieren</button>
      <span class="copied" id="t_copied" style="display:none;">✓ kopiert</span>
    </div>

    <div class="band band-3" id="band_4t">
      <div id="band_low" class="bandbox">
        <strong>0–3</strong>
        niedrig
      </div>
      <div id="band_int" class="bandbox">
        <strong>4–5</strong>
        intermediär
      </div>
      <div id="band_high" class="bandbox">
        <strong>6–8</strong>
        hoch
      </div>
    </div>

    <div class="interpret" id="t_interpret">
      <strong>Interpretation:</strong> —
    </div>
  </div>

  <!-- ===================== LABOR ===================== -->
  <div id="section_lab" class="hidden">
    <h2>Labor (Stufe 1 & 2)</h2>

    <div class="item">
      <div class="title">Stufe 1: PF4/Heparin-Antikörper (Immunoassay)</div>
      <div class="explain">
        Ergebnis auswählen. Optional: Signalstärke/OD eintragen (falls vorhanden).
      </div>

      <div class="row">
        <select id="pf4_result">
          <option value="unset">Bitte auswählen…</option>
          <option value="neg">Negativ</option>
          <option value="pos">Positiv</option>
          <option value="ind">Grenzwertig/unklar</option>
        </select>

        <span class="pill">optional: OD/Signal</span>
        <input type="number" id="pf4_od" step="0.1" min="0" placeholder="z.B. 0.9">
      </div>

      <div class="smallnote">
        OD/Signal ist laborabhängig und nicht 1:1 vergleichbar. Tendenziell spricht ein stark positives Signal eher für plättchenaktivierende Antikörper – die klinische Einordnung bleibt entscheidend.
      </div>
    </div>

    <div class="item">
      <div class="title">Stufe 2: Funktioneller Test (SRA/HIPA o.ä.)</div>
      <div class="explain">Ergebnis auswählen (sofern veranlasst/verfügbar).</div>

      <div class="row">
        <select id="func_result">
          <option value="unset">Bitte auswählen…</option>
          <option value="pos">Positiv</option>
          <option value="neg">Negativ</option>
          <option value="pend">Ausstehend</option>
          <option value="na">Nicht veranlasst / nicht verfügbar</option>
        </select>
      </div>
    </div>

    <div class="interpret" id="lab_interpret">
      <strong>Labor-Interpretation:</strong> —
    </div>

    <div class="divider"></div>

    <div class="item">
      <div class="title">Automatische Gesamteinordnung (Klinik + Labor)</div>
      <div class="explain" id="lab_conclusion">—</div>
    </div>
  </div>

</div>

<script>
function punktText(n) { return (n === 1) ? "Punkt" : "Punkte"; }

function showSection(which) {
  document.getElementById("section_algo").classList.toggle("hidden", which !== "algo");
  document.getElementById("section_4t").classList.toggle("hidden", which !== "4t");
  document.getElementById("section_lab").classList.toggle("hidden", which !== "lab");
}

function clearBand(ids) {
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove("band-active");
  });
}
function setBandActive(id) {
  const el = document.getElementById(id);
  if (el) el.classList.add("band-active");
}

function parseSelectPoints(val) {
  if (val === "0x") return 0;
  const n = Number(val);
  return Number.isFinite(n) ? n : 0;
}

function calc4T() {
  const a = parseSelectPoints(document.getElementById("t_platelets").value);
  const b = parseSelectPoints(document.getElementById("t_timing").value);
  const c = parseSelectPoints(document.getElementById("t_thrombosis").value);
  const d = parseSelectPoints(document.getElementById("t_other").value);

  const allSelected =
    document.getElementById("t_platelets").value !== "0" &&
    document.getElementById("t_timing").value !== "0" &&
    document.getElementById("t_thrombosis").value !== "0" &&
    document.getElementById("t_other").value !== "0";

  const score = a + b + c + d;

  document.getElementById("t_result").textContent = score;

  // Band
  clearBand(["band_low","band_int","band_high"]);
  clearBand(["band_low_algo","band_int_algo","band_high_algo"]);
  if (score <= 3) { setBandActive("band_low"); setBandActive("band_low_algo"); }
  else if (score <= 5) { setBandActive("band_int"); setBandActive("band_int_algo"); }
  else { setBandActive("band_high"); setBandActive("band_high_algo"); }

  // Interpretation
  const interpEl = document.getElementById("t_interpret");
  if (!allSelected) {
    interpEl.innerHTML = `<strong>Interpretation:</strong> Bitte alle 4 Kategorien auswählen.`;
  } else if (score <= 3) {
    interpEl.innerHTML =
      `<strong>Interpretation:</strong> Niedrige Vortest-Wahrscheinlichkeit (4T 0–3). HIT II ist sehr unwahrscheinlich; vorrangig alternative Ursachen prüfen.`;
  } else if (score <= 5) {
    interpEl.innerHTML =
      `<strong>Interpretation:</strong> Intermediäre Wahrscheinlichkeit (4T 4–5). HIT II möglich → Heparin i. d. R. stoppen, alternative Antikoagulation erwägen/initiieren, PF4-Test veranlassen.`;
  } else {
    interpEl.innerHTML =
      `<strong>Interpretation:</strong> Hohe Wahrscheinlichkeit (4T 6–8). HIT II wahrscheinlich → Heparin sofort stoppen, alternative Antikoagulation beginnen, PF4-Test + funktionellen Test veranlassen.`;
  }

  return { score, allSelected };
}

function interpretPF4(pf4, od) {
  if (pf4 === "unset") return "nicht gesetzt";
  if (pf4 === "neg") return "negativ";
  if (pf4 === "ind") return "grenzwertig/unklar";
  if (pf4 === "pos") {
    if (Number.isFinite(od) && od > 0) return `positiv (OD/Signal: ${od})`;
    return "positiv";
  }
  return "nicht gesetzt";
}

function labInterpretation(pret) {
  const pf4 = document.getElementById("pf4_result").value;
  const odRaw = document.getElementById("pf4_od").value;
  const od = (odRaw === "" ? NaN : Number(odRaw));
  const func = document.getElementById("func_result").value;

  // PF4 text
  const pf4Text = interpretPF4(pf4, od);

  // Basic lab interpretation block
  let labText = "";
  if (pf4 === "unset") {
    labText = "PF4/Heparin-Antikörper nicht gesetzt.";
  } else if (pf4 === "neg") {
    labText = "PF4/Heparin-Antikörper negativ → HIT II sehr unwahrscheinlich (bei plausibler Probenqualität/Timing).";
  } else if (pf4 === "ind") {
    labText = "PF4/Heparin-Antikörper grenzwertig/unklar → Einordnung im klinischen Kontext; häufig Bestätigung/Repeat bzw. funktioneller Test sinnvoll.";
  } else if (pf4 === "pos") {
    labText = "PF4/Heparin-Antikörper positiv → kann HIT II bedeuten, aber auch falsch positiv sein (v. a. postoperativ/Intensiv). Ein funktioneller Test klärt plättchenaktivierende Antikörper.";
  }

  // Functional add-on
  if (func === "pos") labText += " Funktioneller Test positiv → plättchenaktivierende Antikörper nachgewiesen.";
  else if (func === "neg") labText += " Funktioneller Test negativ → HIT II eher unwahrscheinlich, v. a. bei niedriger/intermediärer Vortestwahrscheinlichkeit.";
  else if (func === "pend") labText += " Funktioneller Test ausstehend → bis zum Ergebnis klinisch risikoorientiert weiterführen.";
  else if (func === "na") labText += " Funktioneller Test nicht veranlasst/nicht verfügbar → Risikoeinschätzung basiert auf 4T + PF4 + Klinik.";

  document.getElementById("lab_interpret").innerHTML = `<strong>Labor-Interpretation:</strong> ${labText}`;

  // Now combined conclusion in Lab section
  const { score, allSelected } = pret;

  const riskCat = !allSelected ? "unvollständig" : (score <= 3 ? "low" : (score <= 5 ? "int" : "high"));

  let conclusion = "";
  // Conservative, algorithmic wording
  if (!allSelected) {
    conclusion = "Bitte zunächst den 4T-Score vollständig erheben, dann Labor im Kontext interpretieren.";
  } else if (riskCat === "low") {
    if (pf4 === "neg") {
      conclusion = "Gesamtbild: niedrige Vortestwahrscheinlichkeit + PF4 negativ → HIT II praktisch ausgeschlossen. Andere Ursachen priorisieren.";
    } else if (pf4 === "pos" || pf4 === "ind") {
      conclusion = "Gesamtbild: niedrige Vortestwahrscheinlichkeit + (grenzwertig/positiv) → häufiger falsch positiv. HIT II insgesamt unwahrscheinlich; bei klinischen Warnzeichen (Thrombose/Hautnekrose) dennoch kritisch prüfen.";
    } else {
      conclusion = "Gesamtbild: niedrige Vortestwahrscheinlichkeit. PF4-Test ist in der Regel nicht erforderlich; wenn bereits abgenommen, Ergebnis klinisch zurückhaltend interpretieren.";
    }
  } else { // int/high
    if (pf4 === "neg") {
      conclusion = "Gesamtbild: 4T ≥4, aber PF4 negativ → HIT II sehr unwahrscheinlich. Alternative Ursachen suchen; ggf. Rücksprache Hämostaseologie/Transfusionsmedizin bei hoher klinischer Diskrepanz.";
    } else if (pf4 === "pos") {
      if (func === "pos") {
        conclusion = "Gesamtbild: 4T ≥4 + PF4 positiv + funktionell positiv → HIT II bestätigt. Heparin strikt meiden; alternative Antikoagulation fortführen; Thrombosesuche/Behandlungsstrategie gemäß lokalem Standard.";
      } else if (func === "neg") {
        conclusion = "Gesamtbild: 4T ≥4 + PF4 positiv, aber funktionell negativ → HIT II eher unwahrscheinlich. Konstellation diskutieren (Assay/Timing/Interferenzen); häufig kann Heparin wieder erwogen werden, wenn klinisch vertretbar.";
      } else if (func === "pend") {
        conclusion = "Gesamtbild: 4T ≥4 + PF4 positiv, funktionell ausstehend → bis Klärung HIT-sicheres Vorgehen (Heparin vermeiden, alternative Antikoagulation gemäß Risiko).";
      } else { // na/unset
        conclusion = "Gesamtbild: 4T ≥4 + PF4 positiv → HIT II möglich. Wenn klinisch relevant, funktionellen Test veranlassen (Bestätigung) und bis zur Klärung HIT-sicher managen.";
      }
    } else if (pf4 === "ind") {
      if (func === "pos") {
        conclusion = "Gesamtbild: 4T ≥4 + PF4 grenzwertig + funktionell positiv → HIT II bestätigt (funktioneller Test entscheidend).";
      } else if (func === "neg") {
        conclusion = "Gesamtbild: 4T ≥4 + PF4 grenzwertig + funktionell negativ → HIT II eher unwahrscheinlich. Alternativen prüfen, Verlauf/Repeat je nach Klinik.";
      } else {
        conclusion = "Gesamtbild: 4T ≥4 + PF4 grenzwertig → funktioneller Test/Repeat sinnvoll; bis zur Klärung risikoorientiert HIT-sicher handeln.";
      }
    } else { // pf4 unset
      conclusion = "Gesamtbild: 4T ≥4 ohne PF4-Ergebnis → PF4/Heparin-Antikörpertest veranlassen. Bis dahin Heparin meiden und alternative Antikoagulation je nach klinischem Risiko.";
    }
  }

  document.getElementById("lab_conclusion").textContent = conclusion;

  // Update algorithm section pills
  document.getElementById("algo_pf4_val").textContent = pf4Text;
  document.getElementById("algo_func_val").textContent =
    (func === "unset") ? "nicht gesetzt" :
    (func === "pos") ? "positiv" :
    (func === "neg") ? "negativ" :
    (func === "pend") ? "ausstehend" : "nicht veranlasst";

  return { pf4, pf4Text, od, func, conclusion };
}

function immediateActions(pret, lab) {
  const { score, allSelected } = pret;

  let text = "";
  let cls = "";

  if (!allSelected) {
    text = "Bitte 4T-Score vollständig auswählen. Danach ergeben sich die Sofortmaßnahmen (Heparin stoppen ja/nein, Alternativantikoagulation ja/nein, Labor ja/nein).";
    cls = "warn";
  } else if (score <= 3) {
    text = "Bei 4T 0–3: HIT II sehr unwahrscheinlich → Heparin kann i. d. R. fortgeführt werden; PF4-Test ist meist nicht erforderlich; alternative Ursachen der Thrombozytopenie prüfen.";
    cls = "ok";
  } else {
    text = "Bei 4T ≥4: HIT II möglich/wahrscheinlich → Heparin sofort absetzen (inkl. Spülungen/Heparinbeschichtungen), HIT-sichere Antikoagulation erwägen/initiieren und PF4-Test veranlassen. Bei hoher Wahrscheinlichkeit meist unmittelbar alternative Antikoagulation beginnen.";
    cls = "danger";
    // refine if PF4 negative already
    if (lab && lab.pf4 === "neg") {
      text += " PF4 ist negativ: HIT II wird dadurch sehr unwahrscheinlich; Management kann je nach Klinik reevaluiert werden.";
      cls = "warn";
    }
  }

  const el = document.getElementById("algo_immediate");
  el.textContent = text;
  el.parentElement.classList.remove("ok","warn","danger");
  el.parentElement.classList.add(cls);
}

function updateAlgorithm() {
  // hide copied messages when changes
  document.getElementById("copied").style.display = "none";
  document.getElementById("t_copied").style.display = "none";

  const pret = calc4T();
  document.getElementById("algo_4t_val").textContent = pret.score;

  const lab = labInterpretation(pret);

  // Algorithm conclusion summary
  let status = "";
  if (!pret.allSelected) status = "Bitte 4T-Score vervollständigen.";
  else if (pret.score <= 3) status = "4T niedrig → HIT II unwahrscheinlich.";
  else if (pret.score <= 5) status = "4T intermediär → HIT II möglich (Abklärung/Management).";
  else status = "4T hoch → HIT II wahrscheinlich (HIT-sicheres Vorgehen).";

  const sumEl = document.getElementById("algo_summary");
  sumEl.innerHTML = `<strong>Status:</strong> ${status}`;

  // Immediate actions block
  immediateActions(pret, lab);

  // Final combined conclusion in algorithm section
  const concEl = document.getElementById("algo_conclusion");
  concEl.textContent = lab.conclusion;

  // Styling: highlight summary box based on risk
  sumEl.classList.remove("ok","warn","danger");
  if (!pret.allSelected) sumEl.classList.add("warn");
  else if (pret.score <= 3) sumEl.classList.add("ok");
  else if (pret.score <= 5) sumEl.classList.add("warn");
  else sumEl.classList.add("danger");

  return { pret, lab };
}

/* ===== Copy buttons ===== */
document.getElementById("t_copy").addEventListener("click", () => {
  const score = Number(document.getElementById("t_result").textContent);
  const text = `4T-Score: ${score} ${punktText(score)}`;
  navigator.clipboard.writeText(text).then(() => {
    const msg = document.getElementById("t_copied");
    msg.style.display = "inline";
    setTimeout(() => msg.style.display = "none", 1500);
  });
});

document.getElementById("copy_summary").addEventListener("click", () => {
  const { pret, lab } = updateAlgorithm();

  const risk =
    (!pret.allSelected) ? "4T unvollständig" :
    (pret.score <= 3) ? "4T niedrig (0–3)" :
    (pret.score <= 5) ? "4T intermediär (4–5)" :
    "4T hoch (6–8)";

  const pf4 = (document.getElementById("pf4_result").value === "unset") ? "PF4: n/a" :
    `PF4: ${document.getElementById("algo_pf4_val").textContent}`;

  const func = `Funktionell: ${document.getElementById("algo_func_val").textContent}`;

  const text =
    `HIT-Diagnostik:\n` +
    `${risk}\n` +
    `${pf4}\n` +
    `${func}\n` +
    `Einordnung: ${lab.conclusion}`;

  navigator.clipboard.writeText(text).then(() => {
    const msg = document.getElementById("copied");
    msg.style.display = "inline";
    setTimeout(() => msg.style.display = "none", 1500);
  });
});

/* ===== Jump buttons ===== */
document.getElementById("jump_4t").addEventListener("click", () => {
  document.getElementById("view_4t").checked = true;
  showSection("4t");
});
document.getElementById("jump_lab").addEventListener("click", () => {
  document.getElementById("view_lab").checked = true;
  showSection("lab");
});

/* ===== View toggles ===== */
document.getElementById("view_algo").addEventListener("change", () => showSection("algo"));
document.getElementById("view_4t").addEventListener("change", () => showSection("4t"));
document.getElementById("view_lab").addEventListener("change", () => showSection("lab"));

/* ===== Live recalculation ===== */
["t_platelets","t_timing","t_thrombosis","t_other","pf4_result","pf4_od","func_result"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("change", updateAlgorithm);
  el.addEventListener("input", updateAlgorithm);
});

/* ===== Reset ===== */
document.getElementById("reset").addEventListener("click", () => {
  document.getElementById("t_platelets").value = "0";
  document.getElementById("t_timing").value = "0";
  document.getElementById("t_thrombosis").value = "0";
  document.getElementById("t_other").value = "0";

  document.getElementById("pf4_result").value = "unset";
  document.getElementById("pf4_od").value = "";
  document.getElementById("func_result").value = "unset";

  document.getElementById("copied").style.display = "none";
  document.getElementById("t_copied").style.display = "none";

  updateAlgorithm();
});

/* ===== Initial ===== */
showSection("algo");
updateAlgorithm();
</script>

</body>
</html>
